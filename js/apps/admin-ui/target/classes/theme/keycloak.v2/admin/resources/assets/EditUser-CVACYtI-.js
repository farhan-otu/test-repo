import{jsx as e,jsxs as b,Fragment as $}from"react/jsx-runtime";import{ed as bt,dN as yt,fz as Ct,fA as wt,et as vt,fB as It,fC as kt,fD as Tt,u as Q,a as V,M as We,m as Be,f as O,w as Te,cp as Pt,c as Dt,b as nt,V as ee,d as De,z as Oe,j as Me,B as pe,ez as it,eN as At,L as ot,dh as Lt,T as Se,bm as dt,ah as lt,bn as ct,D as Pe,h as Fe,fE as St,Y as xt,P as ye,dz as Ve,q as J,by as Ue,bx as q,U as Rt,W as Ut,c1 as je,di as Et,c2 as qe,c3 as be,c4 as W,c5 as He,c6 as B,bw as Ot,l as Ae,F as ze,N as Ne,a1 as mt,fb as Mt,d8 as Nt,K as Bt,n as Ke,fF as Ft,cs as Xe,a5 as Ye,y as ut,a8 as zt,_ as Kt,b_ as Ze,cH as Ge,ak as Gt,b$ as $e,fG as Vt,cW as jt,C as qt,dB as Ht,J as et,e as _t,cw as tt,G as xe,H as Re,cP as Wt,ap as _e,dK as $t,bD as Jt,bE as Qt,bl as Xt,cz as Yt,cA as Zt,fv as er,fw as rt}from"./main-hjbDDO6j.js";import{useState as h,useMemo as pt,useRef as tr,Fragment as rr}from"react";import{u as ue,C as gt}from"./ConfirmDialog-DN_NVsrg.js";import{u as ie,R as sr}from"./RoutableTabs-ChOqIl6o.js";import{V as ar}from"./ViewHeader-Dr6ZoEJz.js";import{U as nr}from"./UserProfileContext-knLEppNh.js";import{u as Je}from"./useParams-XtwJXIDJ.js";import{d as ir}from"./differenceBy-BM_QxZMj.js";import{S as or,C as dr}from"./SearchInputComponent-Dywqn1xE.js";import{A as lr}from"./AttributeForm-CrNTp7VT.js";import{a as Ee,R as cr,F as mr,U as ur,t as pr,f as gr}from"./UserForm-uc4P8TwT.js";import{U as hr}from"./userProfileMetadata-CFgHgJ2w.js";import{u as ht}from"./useFormatDate-DtCZfuLt.js";import{s as ft}from"./sortBy-D1UyZ0jY.js";import{C as fr,S as br,i as yr}from"./SessionsTable-BFpY614L.js";import{u as Cr}from"./useLocaleSort-Bon3wgU4.js";import{P as wr}from"./pencil-alt-icon-1xnl9kKm.js";import{T as vr}from"./TimeSelectorControl-BNkqjzSp.js";import{D as Ir}from"./SwitchControl-C_wbgFy3.js";import{G as kr,a as Tr}from"./GroupPickerDialog-CJH5Fdnt.js";import{Q as Pr}from"./question-circle-icon-BckMEuvu.js";import{c as we}from"./capitalize-BLSIhm4V.js";import{R as Dr}from"./AddRoleMappingModal-B-7S42YC.js";import{U as Ar}from"./UserEvents-20oG-Z3I.js";/* empty css                     */import{a as oe,b as de}from"./Tabs-TiG_cKa2.js";import"react-dom";import"./PageHandler-Dm6Ir_Zl.js";import"./DynamicComponents-2Oogxguf.js";import"./ClientSelect-Di5Ep3wz.js";import"./FileUpload-DFzHUp8z.js";import"./CodeEditor-BF8OqNGf.js";import"./copy-icon-ePLWnxgr.js";import"./KeySelect-CBdQO7FV.js";import"./MultiLineInput-BKovUfcB.js";import"./constants-BclHbWtx.js";import"./_baseFlatten-DK0O-V_R.js";import"./FormAccess-DEsYjDHG.js";import"./KeyValueInput-BjiKJH0l.js";import"./CopyToClipboardButton-MzIOrqEi.js";import"./TimeSelector-C-6T-B4N.js";import"./DataListItemRow-C-0mzg8R.js";import"./_baseSlice-F8doVSIJ.js";import"./translationFormatter-aKDacg4X.js";import"./filter-icon-I49U7vdU.js";import"./DropdownPanel-D_qgc_Fl.js";import"./warning-triangle-icon-CUSjnRec.js";import"./pickBy-DbcNzVCB.js";import"./DescriptionListTerm-BGpKKoC6.js";import"./DatePicker-ClawiStM.js";var Lr="[object Map]",Sr="[object Set]",xr=Object.prototype,Rr=xr.hasOwnProperty;function st(t){if(t==null)return!0;if(bt(t)&&(yt(t)||typeof t=="string"||typeof t.splice=="function"||Ct(t)||wt(t)||vt(t)))return!t.length;var r=It(t);if(r==Lr||r==Sr)return!t.size;if(kt(t))return!Tt(t).length;for(var a in t)if(Rr.call(t,a))return!1;return!0}const Ur=({isJoin:t=!0,existingOrgs:r,onAdd:a,onClose:n})=>{const{adminClient:g}=Q(),{t:o}=V(),[c,f]=h([]),m=async(u,p,i)=>{const w={first:u,search:i,max:p+r.length},T=await g.organizations.find(w);return ir(T,r,"id")};return e(We,{variant:Be.small,title:o(t?"joinOrganization":"sendInvitation"),isOpen:!0,onClose:n,actions:[e(O,{"data-testid":"join",variant:"primary",onClick:async()=>{await a(c),n()},children:o(t?"join":"send")},"confirm"),e(O,{"data-testid":"cancel",variant:"link",onClick:n,children:o("cancel")},"cancel")],children:e(Te,{loader:m,isPaginated:!0,ariaLabelKey:"organizationsList",searchPlaceholderKey:"searchOrganization",canSelectAll:!0,onSelect:u=>f([...u]),columns:[{name:"name",displayKey:"organizationName"},{name:"description",cellRenderer:u=>e(Pt,{wrapModifier:"truncate",children:u.description})}]})})},Er=({user:t})=>{const{adminClient:r}=Q(),{t:a}=V(),{id:n}=Dt(),g=nt(),{addAlert:o,addError:c}=ee(),{realm:f}=De(),[m,u]=h(0),p=()=>u(m+1),[i,w,T]=Oe(),[D,v]=h(!0),[I,R]=h(!1),[X,Z]=h([]),[H,F]=h([]),[j,U]=h(""),[L,z]=h(""),[d,x]=h([]),[K,l]=h(!1),S=[{value:"Managed",label:"Managed"},{value:"Unmanaged",label:"Unmanaged"}],G=()=>{l(!K)},_=(A,M)=>{d.includes(M)?x(d.filter(N=>N!==M)):x([...d,M]),l(!1),p()};Me(async()=>{const A=await r.organizations.memberOrganizations({userId:n});let N=await Promise.all(A.map(async se=>{const ge=se.id,ke=(await r.organizations.listMembers({orgId:ge})).filter(le=>le.username===t.username).map(le=>St()(le.membershipType));return{...se,membershipType:ke}}));return d.length>0&&(N=N.filter(se=>se.membershipType?.some(ge=>d.includes(ge)))),L&&(N=N.filter(se=>se.name?.toLowerCase().includes(L.toLowerCase()))),N},Z,[m,d,L]);const te=A=>{U(A)},fe=()=>{z(j),p()},re=()=>{U(""),z(""),p()},[Ce,ve]=ue({titleKey:"removeConfirmOrganizationTitle",messageKey:a("organizationRemoveConfirm",{count:H.length}),continueButtonLabel:"remove",continueButtonVariant:pe.danger,onConfirm:async()=>{try{await Promise.all(H.map(M=>r.organizations.delMember({orgId:M.id,userId:n}))),o(a("organizationRemovedSuccess")),await r.users.findOne({id:n})||g(it({realm:f})),F([]),p()}catch(A){c("organizationRemoveError",A)}}});return b($,{children:[I&&e(Ur,{isJoin:D,existingOrgs:X,onClose:()=>R(!1),onAdd:async A=>{try{await Promise.all(A.map(M=>{const N=new FormData;return N.append("id",n),D?r.organizations.addMember({orgId:M.id,userId:n}):r.organizations.inviteExistingUser({orgId:M.id},N)})),o(a(D?"userAddedOrganization":"userInvitedOrganization",{count:A.length})),p()}catch(M){c(D?"userAddedOrganizationError":"userInvitedError",M)}}}),e(ve,{}),e(At,{link:({organization:A,children:M})=>e(ot,{to:Lt({realm:f,id:A.id,tab:"settings"}),children:M},A.id),loader:X,isSearching:L.length>0||d.length>0,onSelect:A=>F(A),deleteLabel:"remove",onDelete:A=>{F([A]),Ce()},toolbarItem:b($,{children:[e(Se,{children:e(or,{value:j,placeholder:a("searchMembers"),onChange:te,onSearch:fe,onClear:re,"aria-label":a("searchMembers")})}),e(Se,{children:e(dt,{onOpenChange:T,toggle:A=>e(lt,{ref:A,id:"toggle-id",onClick:w,variant:"primary",children:a("joinOrganization")}),isOpen:i,children:b(ct,{children:[e(Pe,{onClick:()=>{v(!0),R(!0)},children:a("joinOrganization")},"join"),e(Pe,{onClick:()=>{v(!1),R(!0)},children:a("sendInvite")},"invite")]})})}),e(Se,{children:e(O,{"data-testid":"removeOrganization",variant:"secondary",isDisabled:H.length===0,onClick:()=>Ce(),children:a("remove")})}),e(Se,{children:e(dr,{filterPlaceholderText:a("filterByMembershipType"),isOpen:K,options:S,onOpenChange:A=>l(A),onToggleClick:G,onSelect:_,selectedItems:d,width:"260px"})})]}),children:e(Fe,{message:a("emptyUserOrganizations"),instructions:a("emptyUserOrganizationsInstructions"),secondaryActions:[{text:a("joinOrganization"),onClick:()=>{v(!0),R(!0)}},{text:a("sendInvitation"),onClick:()=>{v(!1),R(!0)}}]})})]})},Or=({user:t,save:r,upConfig:a})=>{const n=xt();return e(ye,{variant:Ve.light,children:e(lr,{form:n,save:r,fineGrainedAccess:t.access?.manage,reset:()=>n.reset({...n.getValues(),attributes:Ee(t).attributes}),name:"unmanagedAttributes",isDisabled:hr.AdminView==a?.unmanagedAttributePolicy})})},Mr=()=>{const{adminClient:t}=Q(),[r,a]=h(),{t:n}=V(),{addAlert:g,addError:o}=ee(),c=ht(),[f,m]=h(0),{id:u}=Je(),p=I=>ft(I,R=>R.clientId?.toUpperCase()),i=()=>m(new Date().getTime()),w=async()=>{const I=await t.users.listConsents({id:u});return p(I)},T=({grantedClientScopes:I})=>e(Rt,{className:"kc-consents-chip-group",children:I.map(R=>e(Ut,{isReadOnly:!0,className:"kc-consents-chip",children:R},R))}),[D,v]=ue({titleKey:"revokeClientScopesTitle",messageKey:n("revokeClientScopes",{clientId:r?.clientId}),continueButtonLabel:"revoke",continueButtonVariant:pe.danger,onConfirm:async()=>{try{await t.users.revokeConsent({id:u,clientId:r.clientId}),i(),g(n("deleteGrantsSuccess"),J.success)}catch(I){o("deleteGrantsError",I)}}});return b($,{children:[e(v,{}),e(Te,{loader:w,ariaLabelKey:"roleList",searchPlaceholderKey:" ",columns:[{name:"clientId",displayKey:"Client",cellFormatters:[Ue()],transforms:[q(20)]},{name:"grantedClientScopes",displayKey:"grantedClientScopes",cellRenderer:T,transforms:[q(30)]},{name:"createdDate",displayKey:"created",transforms:[q(20)],cellRenderer:({createdDate:I})=>I?c(new Date(I)):"—"},{name:"lastUpdatedDate",displayKey:"lastUpdated",transforms:[q(10)],cellRenderer:({lastUpdatedDate:I})=>I?c(new Date(I)):"—"}],actions:[{title:n("revoke"),onRowClick:I=>{a(I),D()}}],emptyState:e(Fe,{hasIcon:!0,icon:fr,message:n("noConsents"),instructions:n("noConsentsText")})},f)]})},Nr=({credentialData:t,onClose:r})=>{const{t:a}=V();return e(We,{variant:Be.medium,title:a("passwordDataTitle"),"data-testid":"passwordDataDialog",isOpen:!0,onClose:r,children:b(je,{"aria-label":a("passwordDataTitle"),"data-testid":"password-data-dialog",variant:Et.compact,children:[e(qe,{children:b(be,{children:[e(W,{children:a("showPasswordDataName")}),e(W,{children:a("showPasswordDataValue")})]})}),e(He,{children:t.map((n,g)=>b(be,{children:[e(B,{children:n[0]}),e(B,{children:n[1]})]},g))})]})})},Br=({credential:t,resetPassword:r,toggleDelete:a,children:n})=>{const g=ht(),{t:o}=V(),[c,f]=Oe(),[m,u]=Oe(),p=Cr(),i=pt(()=>{if(!t.credentialData)return[];const w=JSON.parse(t.credentialData);return p(Object.entries(w),([T])=>T).map(([T,D])=>typeof D=="string"?[T,D]:[T,JSON.stringify(D)])},[t.credentialData]);return b($,{children:[c&&Object.keys(t).length!==0&&e(Nr,{credentialData:i,onClose:()=>{f()}}),e(B,{children:n}),e(B,{children:g(new Date(t.createdDate))}),e(B,{children:e(O,{className:"kc-showData-btn",variant:"link","data-testid":"showDataBtn",onClick:f,children:o("showDataBtn")})}),t.type==="password"?e(B,{isActionCell:!0,children:e(O,{variant:"secondary","data-testid":"resetPasswordBtn",onClick:r,children:o("resetPasswordBtn")})}):e(B,{}),e(B,{isActionCell:!0,children:e(dt,{popperProps:{position:"right"},onOpenChange:u,toggle:w=>e(lt,{ref:w,isExpanded:m,onClick:u,variant:"plain","aria-label":"Kebab toggle",children:e(Ot,{})}),isOpen:m,children:e(ct,{children:e(Pe,{"data-testid":"deleteDropdownItem",component:"button",onClick:()=>{a(),u()},children:o("deleteBtn")},t.id)})})})]})},Fr=({userId:t,credential:r,isEditable:a,toggle:n})=>{const{adminClient:g}=Q(),{t:o}=V(),{register:c,handleSubmit:f}=Ae(),{addAlert:m,addError:u}=ee();return e(ze,{isHorizontal:!0,className:"kc-form-userLabel",onSubmit:f(async i=>{try{await g.users.updateCredentialLabel({id:t,credentialId:r.id},i.userLabel||""),m(o("updateCredentialUserLabelSuccess"),J.success),n()}catch(w){u("updateCredentialUserLabelError",w)}}),children:e(Ne,{fieldId:"kc-userLabel",className:"kc-userLabel-row",children:e("div",{className:"kc-form-group-userLabel",children:a?b($,{children:[e(mt,{"data-testid":"userLabelFld",defaultValue:r.userLabel,className:"kc-userLabel","aria-label":o("userLabel"),...c("userLabel")}),b("div",{className:"kc-userLabel-actionBtns",children:[e(O,{"data-testid":"editUserLabelAcceptBtn",variant:"link",className:"kc-editUserLabelAcceptBtn","aria-label":o("acceptBtn"),type:"submit",icon:e(Mt,{})}),e(O,{"data-testid":"editUserLabelCancelBtn",variant:"link",className:"kc-editUserLabel-cancelBtn","aria-label":o("cancelBtn"),onClick:n,icon:e(Nt,{})})]})]}):b($,{children:[r.userLabel,e(O,{"aria-label":o("editUserLabel"),variant:"link",className:"kc-editUserLabel-btn",onClick:n,"data-testid":"editUserLabelBtn",icon:e(wr,{})})]})})})})},zr=()=>{const{t}=V();return e(vr,{name:"lifespan",label:t("lifespan"),labelIcon:t("lifespanHelp"),units:["minute","hour","day"],menuAppendTo:"parent",controller:{}})},Kr=({userId:t,onClose:r})=>{const{adminClient:a}=Q(),{realmRepresentation:n}=De(),{t:g}=V(),o=Ae({defaultValues:{actions:[],lifespan:n?.actionTokenGeneratedByAdminLifespan}}),{handleSubmit:c,control:f}=o,m=Bt({control:f,name:"actions"}),u=!st(m),{addAlert:p,addError:i}=ee(),w=async({actions:T,lifespan:D})=>{if(!st(T))try{await a.users.executeActionsEmail({id:t,actions:T,lifespan:D}),p(g("credentialResetEmailSuccess"),J.success),r()}catch(v){i("credentialResetEmailError",v)}};return e(gt,{variant:Be.medium,titleKey:"credentialReset",open:!0,onCancel:r,toggleDialog:r,continueButtonLabel:"credentialResetConfirm",onConfirm:()=>{c(w)()},confirmButtonDisabled:!u,children:e(ze,{id:"userCredentialsReset-form",isHorizontal:!0,"data-testid":"credential-reset-modal",children:b(Ke,{...o,children:[e(cr,{name:"actions",label:"resetAction",help:"resetActions"}),e(zr,{})]})})})},Gr={password:"",passwordConfirmation:"",temporaryPassword:!0},Vr=({user:t,isResetPassword:r,onAddRequiredActions:a,refresh:n,onClose:g})=>{const{adminClient:o}=Q(),{t:c}=V(),f=Ae({defaultValues:Gr,mode:"onChange"}),{register:m,formState:{isValid:u,errors:p},watch:i,handleSubmit:w,clearErrors:T,setError:D}=f,[v,I]=Oe(!0),R=i("password",""),X=i("passwordConfirmation",""),{addAlert:Z,addError:H}=ee(),[F,j]=ue({titleKey:r?"resetPasswordConfirm":"setPasswordConfirm",messageKey:r?c("resetPasswordConfirmText",{username:t.username}):c("setPasswordConfirmText",{username:t.username}),continueButtonLabel:r?"resetPassword":"savePassword",continueButtonVariant:pe.danger,onConfirm:()=>w(U)()}),U=async({password:d,temporaryPassword:x})=>{try{await o.users.resetPassword({id:t.id,credential:{temporary:x,type:"password",value:d}}),x&&a?.([Ft.UPDATE_PASSWORD]);const l=(await o.users.getCredentials({id:t.id})).find(S=>S.type==="password");l&&await o.users.updateCredentialLabel({id:t.id,credentialId:l.id},c("defaultPasswordLabel")),Z(c(r?"resetCredentialsSuccess":"savePasswordSuccess"),J.success),n()}catch(K){H(r?"resetPasswordError":"savePasswordError",K)}g()},{onChange:L,...z}=m("password",{required:!0});return b($,{children:[e(j,{}),e(gt,{titleKey:r?c("resetPasswordFor",{username:t.username}):c("setPasswordFor",{username:t.username}),open:v,onCancel:g,toggleDialog:I,onConfirm:F,confirmButtonDisabled:!u,continueButtonLabel:"save",children:b(ze,{id:"userCredentials-form",isHorizontal:!0,className:"keycloak__user-credentials__reset-form",children:[b(Ne,{name:"password",label:c("password"),fieldId:"password",isRequired:!0,children:[e(Xe,{"data-testid":"passwordField",id:"password",onChange:d=>{L(d),X!==d.currentTarget.value?D("passwordConfirmation",{message:c("confirmPasswordDoesNotMatch").toString()}):T("passwordConfirmation")},...z}),p.password&&e(Ye,{message:c("required")})]}),b(Ne,{name:"passwordConfirmation",label:c(r?"resetPasswordConfirmation":"passwordConfirmation"),fieldId:"passwordConfirmation",isRequired:!0,children:[e(Xe,{"data-testid":"passwordConfirmationField",id:"passwordConfirmation",...m("passwordConfirmation",{required:!0,validate:d=>d===R||c("confirmPasswordDoesNotMatch").toString()})}),p.passwordConfirmation&&e(Ye,{message:p.passwordConfirmation.message})]}),e(Ke,{...f,children:e(Ir,{name:"temporaryPassword",label:c("temporaryPassword"),labelIcon:c("temporaryPasswordHelpText"),defaultValue:"true"})})]})})]})},at=({credential:t,userId:r,toggleDelete:a,resetPassword:n,isUserLabelEdit:g,setIsUserLabelEdit:o,refresh:c})=>e(Br,{credential:t,toggleDelete:()=>a(t),resetPassword:n,children:e(Fr,{credential:t,userId:r,isEditable:g?.status&&g.rowKey===t.id||!1,toggle:()=>{o({status:!g?.status,rowKey:t.id}),g?.status&&c()}})},t.id),jr=({user:t,setUser:r})=>{const{adminClient:a}=Q(),{t:n}=V(),{addAlert:g,addError:o}=ee(),[c,f]=h(0),m=()=>f(c+1),[u,p]=h(!1),[i,w]=h(!1),[T,D]=h([]),[v,I]=h([]),[R,X]=h({}),[Z,H]=h(!1),[F,j]=h(),U=tr(null),[L,z]=h({draggedItemId:"",draggingToItemIndex:-1,dragging:!1,tempItemOrder:[""]});Me(()=>a.users.getCredentials({id:t.id}),s=>{D(s);const y=s.reduce((k,E)=>(k[E.type]=k[E.type]||[],k[E.type].push(E),k),Object.create(null)),C=Object.keys(y).map(k=>({key:k,value:y[k]}));I(C.map(k=>({...k,isExpanded:!1})))},[c]);const d=T.find(s=>s.type==="password"),x=()=>p(!u),K=()=>{w(!i)},l=()=>{H(!0),x()},[S,G]=ue({titleKey:n("deleteCredentialsConfirmTitle"),messageKey:n("deleteCredentialsConfirm"),continueButtonLabel:n("delete"),continueButtonVariant:pe.danger,onConfirm:async()=>{try{await a.users.deleteCredential({id:t.id,credentialId:R.id}),g(n("deleteCredentialsSuccess"),J.success),f(s=>s+1)}catch(s){o("deleteCredentialsError",s)}}}),_=pt(()=>v.flatMap(s=>[s.value.map(({id:y})=>y).toString(),...s.isExpanded?s.value.map(y=>y.id):[]]),[v]),te=s=>{s.dataTransfer.effectAllowed="move",s.dataTransfer.setData("text/plain",s.currentTarget.id);const y=s.currentTarget.id;s.currentTarget.classList.add(Ge.modifiers.ghostRow),s.currentTarget.setAttribute("aria-pressed","true"),z({...L,draggedItemId:y,dragging:!0})},fe=(s,y,C)=>{const k=s.indexOf(y);if(k===C)return s;const E=[...s];return E.splice(C,0,E.splice(k,1)[0]),E},re=s=>{if(!U.current)return;const y=U.current,C=Array.from(y.children);C.every(({id:k},E)=>k===s[E])||(y.replaceChildren(),s.forEach(k=>{y.appendChild(C.find(({id:E})=>E===k))}))},Ce=()=>{U.current&&(Array.from(U.current.children).forEach(s=>{s.classList.remove(Ge.modifiers.ghostRow),s.setAttribute("aria-pressed","false")}),z({...L,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},ve=s=>{A(s)||(re(_),z({...L,draggingToItemIndex:-1}))},A=s=>{if(!U.current)return!1;const y=U.current.getBoundingClientRect();return s.clientX>y.x&&s.clientX<y.x+y.width&&s.clientY>y.y&&s.clientY<y.y+y.height},M=s=>{A(s)?Le(L.draggedItemId,L.tempItemOrder):Ce()},N=s=>{s.preventDefault();const C=s.target.closest("tr");if(!(!C||U.current&&!U.current.contains(C)||C.id===L.draggedItemId)){const k=C.id,E=Array.from(U.current?.children||[]).findIndex(Y=>Y.id===k);if(E===L.draggingToItemIndex)return;const he=fe(_,L.draggedItemId,E);re(he),z({...L,draggingToItemIndex:E,tempItemOrder:he})}},se=s=>{r({...t,requiredActions:[...t.requiredActions??[],...s]})},ge=({target:s})=>{s instanceof HTMLTableRowElement&&(s.classList.remove(Ge.modifiers.ghostRow),s.setAttribute("aria-pressed","false"),z({...L,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},Le=async(s,y)=>{const C=_.findIndex(Y=>Y===s),k=y.findIndex(Y=>Y===s),E=k-C,he=s.split(",");try{for(const Y of he)for(let Qe=0;Qe<Math.abs(E);Qe++)E>0?await a.users.moveCredentialPositionDown({id:t.id,credentialId:Y,newPreviousCredentialId:_[k]}):await a.users.moveCredentialPositionUp({id:t.id,credentialId:Y});m(),g(n("updatedCredentialMoveSuccess"),J.success)}catch(Y){o("updatedCredentialMoveError",Y)}},Ie=s=>{X(s),S()},ke=t.federationLink,[le,P]=h([]);if(Me(()=>a.users.getUserStorageCredentialTypes({id:t.id}),P,[]),!le)return e(ut,{});const ae=le.length>0,ce=v.length===0,me=!t.credentials||t.credentials.length===0,ne=ce&&me&&!ae;return b($,{children:[u&&e(Vr,{user:t,isResetPassword:Z,onAddRequiredActions:se,refresh:m,onClose:()=>p(!1)}),i&&e(Kr,{userId:t.id,onClose:()=>w(!1)}),e(G,{}),t.email&&!ne&&e(O,{className:"kc-resetCredentialBtn-header",variant:"primary","data-testid":"credentialResetBtn",onClick:()=>w(!0),children:n("credentialResetBtn")}),T.length!==0&&d===void 0&&b($,{children:[e(O,{className:"kc-setPasswordBtn-tbl","data-testid":"setPasswordBtn-table",variant:"primary",form:"userCredentials-form",onClick:()=>{p(!0)},children:n("setPassword")}),e(zt,{})]}),v.length!==0&&e(ye,{variant:Ve.light,children:b(je,{variant:"compact",children:[e(qe,{children:b(be,{className:"kc-table-header",children:[e(W,{children:e(Kt,{helpText:n("userCredentialsHelpText"),fieldLabelId:"userCredentialsHelpTextLabel"})}),e(W,{"aria-hidden":"true"}),e(W,{children:n("type")}),e(W,{children:n("userLabel")}),e(W,{children:n("createdAt")}),e(W,{children:n("data")}),e(W,{"aria-hidden":"true"}),e(W,{"aria-hidden":"true"})]})}),e(He,{ref:U,onDragOver:N,onDrop:N,onDragLeave:ve,children:v.map((s,y)=>b(rr,{children:[b(be,{id:s.value.map(({id:C})=>C).toString(),draggable:v.length>1,onDrop:M,onDragEnd:ge,onDragStart:te,children:[e(B,{className:v.length===1?"one-row":"",draggableRow:{id:`draggable-row-${s.value.map(({id:C})=>C)}`}}),s.value.length>1?e(B,{className:"kc-expandRow-btn",expand:{rowIndex:y,isExpanded:s.isExpanded,onToggle:(C,k)=>{const E=v.map((he,Y)=>Y===k?{...he,isExpanded:!he.isExpanded}:he);I(E)}}}):e(B,{}),e(B,{dataLabel:`columns-${s.key}`,className:"kc-notExpandableRow-credentialType","data-testid":"credentialType",children:Ze(s.key)}),s.value.length<=1&&s.value.map(C=>e(at,{credential:C,userId:t.id,toggleDelete:Ie,resetPassword:l,isUserLabelEdit:F,setIsUserLabelEdit:j,refresh:m},C.id))]}),s.isExpanded&&s.value.map(C=>b(be,{id:C.id,draggable:!0,onDrop:M,onDragEnd:ge,onDragStart:te,children:[e(B,{}),e(B,{className:"kc-draggable-dropdown-type-icon",draggableRow:{id:`draggable-row-${s.value.map(({id:k})=>k)}`}}),e(B,{dataLabel:`child-columns-${C.id}`,className:"kc-expandableRow-credentialType",children:Ze(C.type)}),e(at,{credential:C,userId:t.id,toggleDelete:Ie,resetPassword:l,isUserLabelEdit:F,setIsUserLabelEdit:j,refresh:m})]},C.id))]},s.key))})]})}),ke&&ae&&e(ye,{variant:Ve.light,children:b(je,{variant:"compact",children:[e(qe,{children:b(be,{children:[e(W,{children:n("type")}),e(W,{children:n("providedBy")}),e(W,{"aria-hidden":"true"})]})}),e(He,{children:le.map(s=>b(be,{children:[e(B,{children:e("b",{children:s})}),e(B,{children:e(mr,{user:t})}),s==="password"&&e(B,{modifier:"fitContent",children:e(O,{variant:"secondary",onClick:x,children:n("setPassword")})})]},s))})]})}),ne&&e(Fe,{hasIcon:!0,message:n("noCredentials"),instructions:n("noCredentialsText"),primaryActionText:n("setPassword"),onPrimaryAction:x,secondaryActions:t.email?[{text:n("credentialResetBtn"),onClick:K,type:pe.link}]:void 0})]})},qr=({user:t})=>{const{adminClient:r}=Q(),{t:a}=V(),{addAlert:n,addError:g}=ee(),[o,c]=h(0),f=()=>c(o+1),[m,u]=h([]),[p,i]=h(!0),[w,T]=h([]),[D,v]=h(!1),{enabled:I}=Gt(),{hasAccess:R}=$e(),X=R("manage-users"),Z=d=>ft(d,x=>x.path?.toUpperCase()),H=async(d,x,K)=>{const l={first:d,max:x},S=K||"";S&&(l.search=S);const G=await r.users.listGroups({...l,id:t.id});T([...G]);const _=[];return p||G.forEach(te=>{const fe=(te.path?.substring(1).match(/((~\/)|[^/])+/g)||[]).slice(0,-1);_.push(...fe.map(re=>({name:re,path:te.path?.substring(0,te.path.indexOf(re)+re.length)})))}),Z(Ht([...G,..._],"path"))},F=()=>{v(!D)},[j,U]=ue({titleKey:a("leaveGroup",{count:m.length,name:m[0]?.name}),messageKey:a("leaveGroupConfirmDialog",{count:m.length,groupname:m[0]?.name,username:t.username}),continueButtonLabel:"leave",continueButtonVariant:pe.danger,onConfirm:async()=>{try{await Promise.all(m.map(d=>r.users.delFromGroup({id:t.id,groupId:d.id}))),u([]),n(a("removedGroupMembership"),J.success)}catch(d){g("removedGroupMembershipError",d)}f()}}),L=d=>{u(d),j()},z=async d=>{try{await Promise.all(d.map(x=>r.users.addToGroup({id:t.id,groupId:x.id}))),n(a("addedGroupMembership"),J.success)}catch(x){g("addedGroupMembershipError",x)}f()};return b($,{children:[e(U,{}),D&&e(kr,{id:t.id,type:"selectMany",text:{title:a("joinGroupsFor",{username:t.username}),ok:"join"},canBrowse:X,onClose:()=>v(!1),onConfirm:async(d=[])=>{await z(d),v(!1)}}),e(Te,{loader:H,className:"keycloak_user-section_groups-table",isPaginated:!0,ariaLabelKey:"roleList",searchPlaceholderKey:"searchGroup",canSelectAll:!0,onSelect:d=>u(p?d:Vt(d,w,"id")),isRowDisabled:d=>!p&&w.every(x=>x.id!==d.id),toolbarItem:b($,{children:[e(O,{className:"kc-join-group-button",onClick:F,"data-testid":"add-group-button",isDisabled:!t.access?.manageGroupMembership,children:a("joinGroup")}),e(jt,{label:a("directMembership"),id:"kc-direct-membership-checkbox",onChange:()=>{i(!p),f()},isChecked:p,className:"pf-v5-u-mt-sm"},"direct-membership-check"),e(O,{onClick:()=>L(m),"data-testid":"leave-group-button",variant:"link",isDisabled:m.length===0,className:"pf-v5-u-ml-md",children:a("leave")}),I&&e(qt,{"aria-label":"Basic popover",position:"bottom",bodyContent:e("div",{children:a("whoWillAppearPopoverTextUsers")}),children:e(O,{variant:"link",className:"kc-who-will-appear-button",icon:e(Pr,{}),children:a("whoWillAppearLinkTextUsers")},"who-will-appear-button")})]}),columns:[{name:"groupMembership",displayKey:"groupMembership",cellRenderer:d=>d.name||"-",transforms:[q(40)]},{name:"path",displayKey:"path",cellRenderer:d=>e(Tr,{group:d}),transforms:[q(45)]},{name:"",cellRenderer:d=>w.some(K=>K.id===d.id)||w.length===0||p?e(O,{"data-testid":`leave-${d.name}`,onClick:()=>L([d]),variant:"link",isDisabled:!t.access?.manageGroupMembership,children:a("leave")}):"-",transforms:[q(20)]}],emptyState:e(Fe,{hasIcon:!0,message:a("noGroups"),instructions:a("noGroupsText"),primaryActionText:a("joinGroup"),onPrimaryAction:F})},o)]})},Hr=({userId:t,federatedId:r,onClose:a,onRefresh:n})=>{const{adminClient:g}=Q(),{t:o}=V(),{addAlert:c,addError:f}=ee(),m=Ae({mode:"onChange"}),{handleSubmit:u,formState:{isValid:p}}=m,i=async w=>{try{await g.users.addToFederatedIdentity({id:t,federatedIdentityId:r,federatedIdentity:w}),c(o("idpLinkSuccess"),J.success),a(),n()}catch(T){f("couldNotLinkIdP",T)}};return e(We,{variant:Be.small,title:o("linkAccountTitle",{provider:we(r)}),onClose:a,actions:[e(O,{"data-testid":"confirm",variant:"primary",type:"submit",form:"group-form",isDisabled:!p,children:o("link")},"confirm"),e(O,{"data-testid":"cancel",variant:pe.link,onClick:a,children:o("cancel")},"cancel")],isOpen:!0,children:e(ze,{id:"group-form",onSubmit:u(i),children:b(Ke,{...m,children:[e(Ne,{label:o("identityProvider"),fieldId:"identityProvider",children:e(mt,{id:"identityProvider","data-testid":"idpNameInput",value:we(r),readOnly:!0})}),e(et,{name:"userId",label:o("userID"),helperText:o("userIdHelperText"),autoFocus:!0,rules:{required:o("required")}}),e(et,{name:"userName",label:o("username"),helperText:o("usernameHelperText"),rules:{required:o("required")}})]})})})},_r=({userId:t})=>{const{adminClient:r}=Q(),[a,n]=h(0),[g,o]=h(""),[c,f]=h(!1),{realm:m}=De(),{addAlert:u,addError:p}=ee(),{t:i}=V(),{hasAccess:w,hasSomeAccess:T}=$e(),D=T("manage-identity-providers","view-identity-providers"),v=()=>n(new Date().getTime()),I=_t().identityProviders,R=async()=>{const l=await r.users.listFederatedIdentities({id:t});if(D){const S=await r.identityProviders.find();for(const G of l)G.providerId=S.find(_=>_.alias===G.identityProvider)?.providerId}return l},X=async()=>r.identityProviders.find(),Z=async()=>R(),H=async()=>{const l=(await R()).map(S=>S.identityProvider);return(await X())?.filter(S=>!l.includes(S.alias))},[F,j]=ue({titleKey:i("unlinkAccountTitle",{provider:we(g)}),messageKey:i("unlinkAccountConfirm",{provider:we(g)}),continueButtonLabel:"unlink",continueButtonVariant:pe.primary,onConfirm:async()=>{try{await r.users.delFromFederatedIdentity({id:t,federatedIdentityId:g}),u(i("idpUnlinkSuccess"),J.success),v()}catch(l){p("mappingDeletedError",l)}}}),U=l=>D?e(ot,{to:$t({realm:m,providerId:l.providerId,alias:l.identityProvider,tab:"settings"}),children:we(l.identityProvider)}):e("span",{children:we(l.identityProvider)}),L=l=>{const S=I?.find(G=>G.id===l.identityProvider)?.groupName;return e(_e,{color:S==="Social"?"blue":"orange",children:i(S==="Social"?"idpType.social":"idpType.custom")})},z=l=>{const S=I?.find(G=>G.id===l.providerId)?.groupName;return e(_e,{color:S==="User-defined"?"orange":"blue",children:S==="User-defined"?"Custom":S==="Social"?i("idpType.social"):S})},d=l=>w("manage-users")?e(O,{variant:"link",onClick:()=>{o(l.identityProvider),F()},children:i("unlinkAccount")}):e("span",{}),x=l=>e(O,{variant:"link",onClick:()=>{o(l.alias),f(!0)},children:i("linkAccount")}),K=()=>{const l=[{name:"identityProvider",displayKey:"name",cellRenderer:U,transforms:[q(20)]},{name:"userId",displayKey:"userID",cellFormatters:[Ue()],transforms:[q(30)]},{name:"userName",displayKey:"username",cellFormatters:[Ue()],transforms:[q(20)]},{name:"",cellRenderer:d,transforms:[q(20)]}];return D&&l.splice(1,0,{name:"type",displayKey:"type",cellRenderer:L,transforms:[q(10)]}),l};return b($,{children:[c&&e(Hr,{userId:t,federatedId:g,onClose:()=>f(!1),onRefresh:v}),e(j,{}),b(ye,{variant:"light",className:"pf-v5-u-p-0",children:[b(tt,{title:i("linkedIdPs"),className:"kc-linked-idps",children:[e(xe,{children:e(Re,{className:"kc-available-idps-text",children:i("linkedIdPsText")})}),e(Te,{loader:Z,isPaginated:!1,ariaLabelKey:"LinkedIdPs",className:"kc-linked-IdPs-table",columns:K(),emptyState:e(xe,{className:"kc-no-providers-text",children:e(Re,{children:i("noProvidersLinked")})})},a)]}),w("manage-users")&&D&&b(tt,{className:"kc-available-idps",title:i("availableIdPs"),children:[e(xe,{children:e(Re,{className:"kc-available-idps-text",children:i("availableIdPsText")})}),e(Te,{loader:H,isPaginated:!1,ariaLabelKey:"LinkedIdPs",className:"kc-linked-IdPs-table",columns:[{name:"alias",displayKey:"name",cellFormatters:[Ue(),Wt()],transforms:[q(20)]},{name:"type",displayKey:"type",cellRenderer:z,transforms:[q(60)]},{name:"",cellRenderer:x}],emptyState:e(xe,{className:"kc-no-providers-text",children:e(Re,{children:i("noAvailableIdentityProviders")})})},a)]})]})]})},Wr=({id:t,name:r})=>{const{adminClient:a}=Q(),{t:n}=V(),{addAlert:g,addError:o}=ee();return e(Dr,{name:r,id:t,type:"users",save:async f=>{try{const m=f.filter(u=>u.client===void 0).map(u=>u.role).flat();await a.users.addRealmRoleMappings({id:t,roles:m}),await Promise.all(f.filter(u=>u.client!==void 0).map(u=>a.users.addClientRoleMappings({id:t,clientUniqueId:u.client.id,roles:[u.role]}))),g(n("userRoleMappingUpdatedSuccess"),J.success)}catch(m){o("roleMappingUpdatedError",m)}}})},$r=()=>{const{adminClient:t}=Q(),{id:r}=Je(),{realm:a}=De(),{t:n}=V();return e(ye,{variant:"light",className:"pf-v5-u-p-0",children:e(br,{loader:()=>t.users.listSessions({id:r,realm:a}),hiddenColumns:["username","type"],emptyInstructions:n("noSessionsForUser"),logoutUser:r})})};function _s(){const{adminClient:t}=Q(),{t:r}=V(),{addAlert:a,addError:n}=ee(),g=nt(),{hasAccess:o}=$e(),{id:c}=Je(),{realm:f,realmRepresentation:m}=De(),p=Ae({mode:"onChange",resolver:async P=>({values:P,errors:{}})}),[i,w]=h(),[T,D]=h(),[v,I]=h(),[R,X]=h(),[Z,H]=h(0),F=()=>H(P=>P+1),j=yr(i?.id),[U,L]=h(),[z,d]=h(!1),K=Jt()(Qt.Organizations)&&m?.organizationsEnabled,l=P=>Zt({realm:f,id:i?.id||"",tab:P}),S=ie(l("settings")),G=ie(l("attributes")),_=ie(l("credentials")),te=ie(l("role-mapping")),fe=ie(l("groups")),re=ie(l("organizations")),Ce=ie(l("consents")),ve=ie(l("identity-provider-links")),A=ie(l("sessions")),M=ie(l("user-events"));Me(async()=>Promise.all([t.users.findOne({id:c,userProfileMetadata:!0}),t.attackDetection.findOne({id:c}),t.users.getUnmanagedAttributes({id:c}),t.users.getProfile({realm:f}),K?t.organizations.find({first:0,max:1}):[]]),([P,ae,ce,me,ne])=>{if(!P||!m||!ae)throw new Error(r("notFound"));const{userProfileMetadata:s,...y}=P;X(s),y.unmanagedAttributes=ce,y.attributes=gr(y.attributes,ce),me.unmanagedAttributePolicy!==void 0&&I(!0),w(y),L(me);const C=m.bruteForceProtected,k=C&&ae.disabled;D({isBruteForceProtected:C,isLocked:k}),d(ne.length===1),p.reset(Ee(y))},[Z]);const N=async P=>{try{await t.users.update({id:i.id},pr(P)),a(r("userSaved"),J.success),F()}catch(ae){if(er(ae)){if(v&&Array.isArray(P.unmanagedAttributes)){const ce=new Array(P.unmanagedAttributes.length);let me=!1;rt(ae,(ne,s)=>{if(ne.startsWith("attributes.")){const y=ne.substring(11);P.unmanagedAttributes.forEach((C,k)=>{C.key===y&&(ce[k]=s,me=!0)})}else p.setError(ne,s)},(ne,s)=>r(ne,s)),me&&p.setError("unmanagedAttributes",ce)}else rt(ae,p.setError,(ce,me)=>r(ce,me));n("userNotSaved","")}else n("userCreateError",ae)}},[se,ge]=ue({titleKey:"disableConfirmUserTitle",messageKey:"disableConfirmUser",continueButtonLabel:"disable",onConfirm:()=>{N({...Ee(i),enabled:!1})}}),[Le,Ie]=ue({titleKey:"deleteConfirm",messageKey:"deleteConfirmCurrentUser",continueButtonLabel:"delete",continueButtonVariant:pe.danger,onConfirm:async()=>{try{j?await t.users.logout({id:i.id}):await t.users.del({id:i.id}),a(r("userDeletedSuccess"),J.success),g(it({realm:f}))}catch(P){n("userDeletedError",P)}}}),[ke,le]=ue({titleKey:"impersonateConfirm",messageKey:"impersonateConfirmDialog",continueButtonLabel:"impersonate",onConfirm:async()=>{try{const P=await t.users.impersonation({id:i.id},{user:i.id,realm:f});P.sameRealm?window.location=P.redirect:window.open(P.redirect,"_blank")}catch(P){n("impersonateError",P)}}});return!i||!T?e(ut,{}):b($,{children:[e(le,{}),e(Ie,{}),e(ge,{}),e(ar,{titleKey:i.username,className:"kc-username-view-header",divider:!1,badges:j?[{text:e(Xt,{content:r("transientUserTooltip"),children:e(_e,{"data-testid":"user-details-label-transient-user",icon:e(Yt,{}),children:r("transientUser")})})}]:[],dropdownItems:[e(Pe,{isDisabled:!i.access?.impersonate,onClick:()=>ke(),children:r("impersonate")},"impersonate"),e(Pe,{isDisabled:!i.access?.manage,onClick:()=>Le(),children:r("delete")},"delete")],onToggle:P=>{P?N({...Ee(i),enabled:P}):se()},isEnabled:i.enabled}),e(ye,{variant:"light",className:"pf-v5-u-p-0",children:e(nr,{children:e(Ke,{...p,children:b(sr,{isBox:!0,mountOnEnter:!0,defaultLocation:l("settings"),children:[e(oe,{"data-testid":"user-details-tab",title:e(de,{children:r("details")}),...S,children:e(ye,{variant:"light",children:e(ur,{form:p,realm:m,user:i,bruteForce:T,userProfileMetadata:R,refresh:F,save:N})})}),v&&e(oe,{"data-testid":"attributes",title:e(de,{children:r("attributes")}),...G,children:e(Or,{user:i,save:N,upConfig:U})}),e(oe,{"data-testid":"credentials",isHidden:!i.access?.view,title:e(de,{children:r("credentials")}),..._,children:e(jr,{user:i,setUser:w})}),e(oe,{"data-testid":"role-mapping-tab",isHidden:!i.access?.view,title:e(de,{children:r("roleMapping")}),...te,children:e(Wr,{id:i.id,name:i.username})}),o("query-groups")&&e(oe,{"data-testid":"user-groups-tab",title:e(de,{children:r("groups")}),...fe,children:e(qr,{user:i})}),K&&z&&e(oe,{"data-testid":"user-organizations-tab",title:e(de,{children:r("organizations")}),...re,children:e(Er,{user:i})}),e(oe,{"data-testid":"user-consents-tab",title:e(de,{children:r("consents")}),...Ce,children:e(Mr,{})}),e(oe,{"data-testid":"identity-provider-links-tab",title:e(de,{children:r("identityProviderLinks")}),...ve,children:e(_r,{userId:i.id})}),e(oe,{"data-testid":"user-sessions-tab",title:e(de,{children:r("sessions")}),...A,children:e($r,{})}),o("view-events")&&m?.eventsEnabled&&e(oe,{"data-testid":"user-events-tab",title:e(de,{children:r("events")}),...M,children:e(Ar,{user:i.id})})]})})})})]})}export{_s as default};
//# sourceMappingURL=EditUser-CVACYtI-.js.map
